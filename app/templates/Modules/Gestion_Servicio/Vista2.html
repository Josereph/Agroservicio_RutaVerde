{% extends "layouts/base.html" %}

{% block title %}Agroservicio Ruta Verde - Gestión de Servicios{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/vista2.css') }}">

<div class="container mt-5">
    <h1 class="mb-4 display-4 text-primary-green">Gestión de Servicios</h1>

    <ul class="nav nav-tabs" id="serviciosTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link tab-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro"
                    type="button" role="tab" aria-controls="registro" aria-selected="true">
                Registrar Nuevo Servicio
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link tab-link" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta"
                    type="button" role="tab" aria-controls="consulta" aria-selected="false">
                Servicios Existentes
            </button>
        </li>
    </ul>

    <div class="tab-content tab-content-card" id="serviciosTabContent">

        <!-- ==========================
             REGISTRAR SERVICIO
        =========================== -->
        <div class="tab-pane fade show active" id="registro" role="tabpanel" aria-labelledby="registro-tab">
            <h2 class="h5 mb-4 text-secondary-title">Completa los datos para registrar un nuevo envío:</h2>

            <form action="{{ url_for('main.servicios') }}" method="POST" class="needs-validation" novalidate>
                <div class="row g-4">

                    <!-- CLIENTE -->
                    <div class="col-md-6">
                        <label class="form-label">Cliente</label>
                        <select class="form-select" name="Id_Cliente" required>
                            <option value="">Seleccione...</option>
                            {% for c in clientes %}
                                <option value="{{ c.Id_Cliente }}">{{ c.Nombre_Cliente }} ({{ c.Dui }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- VEHÍCULO -->
                    <div class="col-md-6">
                        <label class="form-label">Vehículo Asignado</label>
                        <select class="form-select" name="Id_Vehiculo" required>
                            <option value="">Seleccione...</option>
                            {% for v in vehiculos %}
                                <option value="{{ v.id_vehiculo }}">{{ v.unidad_numero }} - {{ v.placa }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- CONDUCTOR -->
                    <div class="col-md-6">
                        <label class="form-label">Conductor</label>
                        <select class="form-select" name="id_conductor" required>
                            <option value="">Seleccione...</option>
                            {% for con in conductores %}
                                <option value="{{ con.id_conductor }}">{{ con.nombre_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- TIPO SERVICIO -->
                    <div class="col-md-6">
                        <label class="form-label">Tipo de Servicio</label>
                        <select class="form-select" name="Id_Tipo_Servicio" required>
                            <option value="">Seleccione...</option>
                            {% for ts in tipos_servicio %}
                                <option value="{{ ts.Id_Tipo_Servicio }}">{{ ts.Nombre_Servicio }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- FRAGILIDAD -->
                    <div class="col-md-6">
                        <label class="form-label">Nivel de Fragilidad</label>
                        <select class="form-select" name="Id_Fragilidad" required>
                            <option value="">Seleccione...</option>
                            {% for f in fragilidades %}
                                <option value="{{ f.Id_Fragilidad }}">{{ f.Nivel }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- UBICACION -->
                    <div class="col-md-6">
                        <label class="form-label">Ubicación Logística</label>
                        <select class="form-select" name="Id_Ubicacion" required>
                            <option value="">Seleccione...</option>
                            {% for u in ubicaciones %}
                                <option value="{{ u.Id_Ubicacion }}">
                                    UB-{{ u.Id_Ubicacion }} | {{ u.municipio.Nombre_Municipio }} ({{ u.departamento.Nombre_Departamento }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- PESO -->
                    <div class="col-md-6">
                        <label class="form-label">Peso de la Carga (kg)</label>
                        <input type="number" step="0.01" name="Peso_Carga" class="form-control" required>
                    </div>

                    <!-- PRECIO -->
                    <div class="col-md-6">
                        <label class="form-label">Precio Total ($)</label>
                        <input type="number" step="0.01" name="Precio_Total" class="form-control" required>
                    </div>

                    <!-- FECHAS -->
                    <div class="col-md-6">
                        <label class="form-label">Fecha de Pedido</label>
                        <input type="date" name="Fecha_Pedido" class="form-control" required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Fecha de Entrega Estimada</label>
                        <input type="date" name="Fecha_Entrega" class="form-control" required>
                    </div>

                    <!-- BOTÓN -->
                    <div class="col-12 mt-4 text-end">
                        <button type="submit" class="btn btn-lg btn-primary">
                            <i class="bi bi-save-fill me-2"></i> Registrar Servicio
                        </button>
                    </div>
                </div>
            </form>
        </div>


        <!-- ==========================
             SERVICIOS EXISTENTES
        =========================== -->
        <div class="tab-pane fade" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">
            <h2 class="h5 mb-4 text-secondary-title">Listado de Envíos y su Estado:</h2>

            <div class="row mb-3 align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control custom-input" id="buscadorServicios" placeholder="Buscar por ID, Cliente o Estado...">
                </div>
                <div class="col-md-8 text-end">
                    <button class="btn btn-outline-secondary btn-secondary-action">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Reporte
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle custom-table">
                    <thead class="thead-custom">
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Carga</th>
                            <th>Vehículo</th>
                            <th>Precio</th>
                            <th>Estado Actual</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>

                    <tbody id="tablaServiciosBody">
                    {% if servicios %}
                        {% for s in servicios %}
                            <!-- Intentamos obtener el último estado de forma segura -->
                            {% set estado = s.seguimientos|sort(attribute='id_seguimiento', reverse=true)|first %}

                            <tr>
                                <td class="fw-bold">#{{ s.Id_Servicio }}</td>
                                <td>
                                    <div>{{ s.cliente.Nombre_Cliente }}</div>
                                    <small class="text-muted">{{ s.cliente.Dui }}</small>
                                </td>
                                <td>{{ s.Peso_Carga }} kg</td>
                                <td>
                                    <div>{{ s.vehiculo.marca }} {{ s.vehiculo.modelo }}</div>
                                    <small class="text-muted">{{ s.vehiculo.placa }}</small>
                                </td>
                                <td class="text-success fw-bold">${{ s.Precio_Total }}</td>

                                <td>
                                    {% if estado %}
                                        {% if estado.estado_actual == 'entregado' %}
                                            <span class="badge bg-success">Entregado</span>
                                        {% elif estado.estado_actual == 'en_ruta' %}
                                            <span class="badge bg-primary">En Ruta</span>
                                        {% elif estado.estado_actual == 'cargando' %}
                                            <span class="badge bg-warning text-dark">Cargando</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ estado.estado_actual }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-light text-dark border">Pendiente</span>
                                    {% endif %}
                                </td>

                                <td>
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('main.editar_servicio', id_servicio=s.Id_Servicio) }}"
                                           class="btn btn-sm btn-outline-primary" title="Editar / Actualizar Estado">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>

                                        <form action="{{ url_for('main.eliminar_servicio', id_servicio=s.Id_Servicio) }}"
                                              method="POST"
                                              onsubmit="return confirm('¿Estás SEGURO de eliminar el Servicio #{{ s.Id_Servicio }}? Esto borrará también sus evidencias y seguimientos.');">
                                            <button class="btn btn-sm btn-outline-danger" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td>{{ s.Id_Servicio }}</td>
                            <td>{{ s.cliente.Nombre_Cliente }} ({{ s.cliente.Dui }})</td>
                            <td>{{ s.Peso_Carga }} kg</td>
                            <td>{{ s.vehiculo.marca }} / {{ s.vehiculo.modelo }}</td>
                            <td>${{ s.Precio_Total }}</td>

                            <td>
                                {% if estado %}
                                    <span class="badge bg-primary">
                                        {{ estado.estado_actual }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">Sin seguimiento</span>
                                {% endif %}
                            </td>

                            <td>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('main.editar_servicio_get', id_servicio=s.Id_Servicio) }}"
                                       class="btn btn-sm btn-success">Editar</a>

                                    <form action="{{ url_for('main.eliminar_servicio', id_servicio=s.Id_Servicio) }}"
                                          method="POST"
                                          onsubmit="return confirm('¿Seguro que deseas eliminar este servicio?');">
                                        <button class="btn btn-sm btn-danger">Eliminar</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Script Simple para Validacion y Búsqueda -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Validación de Bootstrap
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });

        // 2. Buscador Simple en Tabla
        const inputBusqueda = document.getElementById('buscadorServicios');
        if(inputBusqueda){
            inputBusqueda.addEventListener('keyup', function() {
                const valor = this.value.toLowerCase();
                const filas = document.querySelectorAll('#tablaServiciosBody tr');

                filas.forEach(fila => {
                    const texto = fila.textContent.toLowerCase();
                    fila.style.display = texto.includes(valor) ? '' : 'none';
                });
            });
        }
    });
</script>
{% endblock %}